<template>
	<view class="container">
		<!-- 筛选框 -->
		<view class="filter-box">
			<text>筛选:<input v-model="filterKeyword" type="text" placeholder="输入关键词筛选"></text>
			<button @click="filterUsers">筛选</button>
		</view>

		<!-- 用户列表 -->
		<view class="user-list">
			<view v-for="(user, index) in paginatedUsers" :key="user.id" class="user-item">
				<!-- 添加选项框 -->
				<checkbox-group v-model="selectedUsers">
					<checkbox :value="user.id"></checkbox>
				</checkbox-group>
				<text><strong>ID：</strong>{{ user.id }}</text>
				<text><strong>姓名：</strong>{{ user.name }}</text>
				<text><strong>邮箱：</strong>{{ user.email }}</text>
				<text><strong>电话：</strong>{{ user.phone }}</text>
				<text><strong>是否为管理员</strong>{{ user.admin }}</text>
				<!-- 其他用户信息根据需求展示-->
				<view class="actions">
					<navigator url="/pages/change_user/change_user"> <button @tap="editUser(user)">编辑</button>
					</navigator>
					<button @tap="deleteUser(user.id)">删除</button>
				</view>
			</view>
		</view>

		<view class="down">
			<!-- 全选按钮 -->
			<view class="select-all">
				<checkbox-group v-model="allSelected">
					<checkbox @change="selectAll($event.target.checked)">全选</checkbox>
				</checkbox-group>
			</view>

			<!-- 删除选中按钮 -->
			<view class="delete-selected">
				<button @tap="deleteSelected">删除选中</button>
			</view>
		</view>

		<!-- 分页 -->
		<view class="pagination">
			<button @click="previousPage" :disabled="currentPage === 1">上一页</button>
			<text>{{ currentPage }} / {{ totalPages }}</text>
			<button @click="nextPage" :disabled="currentPage === totalPages">下一页</button>
		</view>
	</view>
</template>

<script>
	export default {
		data() {
			return {
				users: [], // 用户列表数据
				currentPage: 1, // 当前页码
				pageSize: 5, // 每页显示条数
				selectedUsers: [], // 已选中用户的 id 数组
				filterKeyword: '', // 筛选关键词
				allSelected: false // 全选状态
			};
		},
		computed: {
			// 根据筛选关键词过滤后的用户列表
			filteredUsers() {
				if (!this.filterKeyword) {
					return this.users;
				} else {
					const keyword = this.filterKeyword.toLowerCase();
					return this.users.filter(user =>
						user.name.toLowerCase().includes(keyword) || user.email.toLowerCase().includes(keyword)
					);
				}
			},
			// 分页后的用户列表
			paginatedUsers() {
				const start = (this.currentPage - 1) * this.pageSize;
				const end = start + this.pageSize;
				return this.filteredUsers.slice(start, end);
			},
			// 总页数
			totalPages() {
				return Math.ceil(this.filteredUsers.length / this.pageSize);
			}
		},
		methods: {
			// 从后端获取用户数据
			fetchUsers() {
				const token = localStorage.getItem('JWT');
				if (token) {
					uni.request({
						method: 'GET',
						url: 'http://localhost:81/User/userSelect',
						header: {
							'Authorization': token,
							'Content-Type': 'application/json',
							"JWT": localStorage.getItem("JWT")
						},
						success: (res) => {
							if (res.data.success === 1) {
								this.users = res.data.data;
							} else {
								console.error('获取用户列表失败:', res.data.data);
							}
						},
						fail: (err) => {
							console.error('请求失败:', err);
						}
					});
				}
			},
			// 筛选用户
			filterUsers() {
				// 此方法会重新计算 `filteredUsers` 的值，因为 `filterKeyword` 发生了变化
			},
			// 全选
			selectAll(checked) {
				if (checked) {
					this.selectedUsers = this.paginatedUsers.map(user => user.id);
				} else {
					this.selectedUsers = [];
				}
			},
			// 删除选中用户
			deleteSelected() {
				const token = localStorage.getItem('JWT');
				if (token && this.selectedUsers.length > 0) {
					uni.request({
						method: 'POST',
						url: 'http://localhost:81/User/userDelete',
						header: {
							'Authorization': token,
							'Content-Type': 'application/json',
							"JWT": localStorage.getItem("JWT")
						},
						data: JSON.stringify({
							ids: this.selectedUsers.map(String) // 转换为字符串数组
						}),
						success: (res) => {
							if (res.data.success === 1) {
								this.users = this.users.filter(
									user => !this.selectedUsers.includes(user.id)
								);
								this.selectedUsers = [];
							} else {
								console.error('删除用户失败:', res.data.data);
							}
						},
						fail: (err) => {
							console.error('请求失败:', err);
						}
					});
				}
			},
			// 删除单个用户
			deleteUser(userId) {
				const token = localStorage.getItem('JWT');
				if (token) {
					uni.request({
						method: 'POST',
						url: 'http://localhost:81/User/userDelete',
						header: {
							'Authorization': token,
							'Content-Type': 'application/json',
							"JWT": localStorage.getItem("JWT")
						},
						data: JSON.stringify({
							ids: [String(userId)] // 转换为字符串数组
						}),
						success: (res) => {
							if (res.data.success === 1) {
								this.users = this.users.filter(user => user.id !== userId);
							} else {
								console.error('删除用户失败:', res.data.data);
							}
						},
						fail: (err) => {
							console.error('请求失败:', err);
						}
					});
				}
			},
			// 上一页
			previousPage() {
				if (this.currentPage > 1) {
					this.currentPage--;
				}
			},
			// 下一页
			nextPage() {
				if (this.currentPage < this.totalPages) {
					this.currentPage++;
				}
			}
		},
		created() {
			this.fetchUsers(); // 获取用户数据
		},
		onLaunch() {
			let token = localStorage.getItem("JWT");
			if (!token) {
				uni.reLaunch({
					url: '/pages/login/login'
				});
			}
		}
	};
</script>
